<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Spanish Conjugation Helper</title>
<style>
  body{
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    background: linear-gradient(180deg,#f7f9ff,#eef2ff);
    margin:0; padding:0; color:#0f172a;
  }
  .container{
    max-width: 1000px;
    margin: 56px auto;
    padding: 26px;
    background: rgba(255,255,255,.55);
    backdrop-filter: blur(18px);
    border-radius: 22px;
    border: 1px solid rgba(15,23,42,.08);
    box-shadow: 0 20px 50px rgba(0,0,0,.08);
  }
  h1{margin:0 0 8px 0;font-size:22px}
  p{margin:0 0 14px 0;color:#475569;font-size:14px;line-height:1.35}
  textarea{
    width:100%;
    min-height:92px;
    padding:14px;
    font-size:16px;
    border-radius:14px;
    border:1px solid rgba(15,23,42,.15);
    background:rgba(255,255,255,.72);
    outline:none;
  }
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center}
  button{
    padding:12px 22px;
    border-radius:14px;
    border:none;
    font-size:15px;
    cursor:pointer;
    background:linear-gradient(135deg,#6366f1,#3b82f6);
    color:white;
  }
  .ghost{
    background: rgba(255,255,255,.55);
    color:#0f172a;
    border:1px solid rgba(15,23,42,.10);
  }
  .result{
    margin-top:16px;
    padding:14px 18px;
    border-radius:16px;
    background:rgba(255,255,255,.6);
    border:1px solid rgba(15,23,42,.1);
    font-size:22px;
    font-weight:750;
  }
  .sub{
    margin-top:10px;
    font-size:12px;
    color:#64748b;
    line-height:1.35;
    white-space:pre-wrap;
  }
  .error{color:#b91c1c;font-weight:750}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .chip{
    border:1px solid rgba(15,23,42,.12);
    background: rgba(255,255,255,.62);
    border-radius:999px;
    padding:8px 10px;
    font-size:12px;
    cursor:pointer;
    user-select:none;
  }
  .chip:hover{border-color: rgba(99,102,241,.28)}
  details{
    margin-top:16px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(255,255,255,.55);
    border-radius:14px;
    padding:10px 12px;
  }
  summary{cursor:pointer;font-weight:650}
  code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
</style>
</head>
<body>
<div class="container">
  <h1>Spanish Conjugation Helper</h1>
  <p>
    Paste prompts like:
    <br><strong>preterite yo to allow/to leave behind</strong>
    <br><strong>present ustedes to know (how to)</strong>
    <br><strong>imperfect yo to know (someone)</strong>
    <br><span style="color:#64748b">Tip: Ctrl/⌘ + Enter to run</span>
  </p>

  <textarea id="input" placeholder="Paste here..."></textarea>

  <div class="row">
    <button id="go">Get Answer</button>
    <button class="ghost" id="clear">Clear</button>
  </div>

  <div id="output" class="result"></div>
  <div id="debug" class="sub"></div>
  <div id="choices" class="chips"></div>

  <details>
    <summary>Hardcoded irregulars / exceptions</summary>
    <div class="sub" id="exceptions"></div>
  </details>
</div>

<script>
/* =============================
   Utilities
============================= */
function stripAccents(s){ return s.normalize("NFD").replace(/[\u0300-\u036f]/g,""); }
function norm(s){
  return stripAccents((s||"").toLowerCase())
    .replace(/[^\w\s();/,-]/g,"")
    .replace(/\s+/g," ")
    .trim();
}
function words(s){
  return norm(s).split(" ").filter(Boolean);
}
function uniq(arr){ return Array.from(new Set(arr)); }

/* Levenshtein distance for fuzzy matching */
function levenshtein(a,b){
  a = norm(a); b = norm(b);
  const m=a.length, n=b.length;
  if(!m) return n; if(!n) return m;
  const dp = new Array(n+1);
  for(let j=0;j<=n;j++) dp[j]=j;
  for(let i=1;i<=m;i++){
    let prev=dp[0]; dp[0]=i;
    for(let j=1;j<=n;j++){
      const tmp=dp[j];
      const cost = a[i-1]===b[j-1] ? 0 : 1;
      dp[j]=Math.min(dp[j]+1, dp[j-1]+1, prev+cost);
      prev=tmp;
    }
  }
  return dp[n];
}
function similarity(a,b){
  const A=norm(a), B=norm(b);
  const maxLen = Math.max(A.length,B.length) || 1;
  return 1 - (levenshtein(A,B)/maxLen);
}

/* =============================
   Parse tense + subject
============================= */
function parseTense(t){
  if(t.includes("preterite")) return "preterite";
  if(t.includes("imperfect")) return "imperfect";
  if(t.includes("present")) return "present";
  return null;
}
function parseSubject(t){
  const T = " " + t + " ";
  if(T.includes(" ana y yo ") || T.includes(" yo y ana ")) return "nosotros";
  if(T.includes(" y ") && !T.includes(" yo ")) return "ustedes";

  if(T.includes(" vosotros")) return "vosotros";
  if(T.includes(" ustedes")) return "ustedes";
  if(T.includes(" nosotros")) return "nosotros";
  if(T.includes(" tú") || T.includes(" tu ")) return "tu";
  if(T.includes(" yo ")) return "yo";

  // single names => él/ella bucket
  if(/\b(sofia|juan|jorge|pedro|diego|olivia|liliana|luna|ana)\b/.test(t)) return "el";

  if(T.includes(" él") || T.includes(" el ") || T.includes(" ella ")) return "el";
  return null;
}

/* =============================
   Verb inventory (your list)
   - We keep infinitives + reflexive flag + meaning hints (lightweight)
============================= */
const VERBS = [
  // reflexive
  {inf:"aburrirse", ref:true, hints:["bored"]},
  {inf:"asustarse", ref:true, hints:["scared"]},
  {inf:"cansarse", ref:true, hints:["tired"]},
  {inf:"caerse", ref:true, hints:["fall down","fall"]},
  {inf:"mojarse", ref:true, hints:["get wet","wet"]},
  {inf:"moverse", ref:true, hints:["move"]},
  {inf:"olvidarse", ref:true, hints:["forget"]},
  {inf:"pararse", ref:true, hints:["stand up","stop"]},
  {inf:"perderse", ref:true, hints:["get lost","miss out"]},
  {inf:"preocuparse", ref:true, hints:["worry"]},
  {inf:"prepararse", ref:true, hints:["get ready","prepare"]},
  {inf:"quedarse", ref:true, hints:["remain","stay"]},
  {inf:"reirse", ref:true, hints:["laugh"]},         // normalized form
  {inf:"romperse", ref:true, hints:["break"]},
  {inf:"sentarse", ref:true, hints:["sit down"]},
  {inf:"sentirse", ref:true, hints:["feel"]},
  {inf:"subirse", ref:true, hints:["get in","get on","go up"]},
  {inf:"verse", ref:true, hints:["see oneself"]},
  {inf:"vestirse", ref:true, hints:["get dressed","dress"]},
  {inf:"enojarse", ref:true, hints:["angry"]},

  // non-reflexive
  {inf:"andar", hints:["walk","ride","go around"]},
  {inf:"aparecer", hints:["appear"]},
  {inf:"arreglar", hints:["fix","repair"]},
  {inf:"ayudar", hints:["help"]},
  {inf:"bailar", hints:["dance"]},
  {inf:"bajar", hints:["lower","go down"]},
  {inf:"beber", hints:["drink"]},
  {inf:"buscar", hints:["look for","search"]},
  {inf:"cambiar", hints:["change"]},
  {inf:"caminar", hints:["walk"]},
  {inf:"cantar", hints:["sing"]},
  {inf:"celebrar", hints:["celebrate"]},
  {inf:"comer", hints:["eat"]},
  {inf:"compartir", hints:["share"]},
  {inf:"comprar", hints:["buy"]},
  {inf:"conocer", hints:["know someone","meet","encounter"]},
  {inf:"contar", hints:["count","tell"]},
  {inf:"continuar", hints:["continue"]},
  {inf:"creer", hints:["believe"]},
  {inf:"dar", hints:["give"]},
  {inf:"decidir", hints:["decide"]},
  {inf:"decir", hints:["say","tell"]},
  {inf:"decorar", hints:["decorate"]},
  {inf:"dejar", hints:["leave","let","allow","leave behind"]},
  {inf:"describir", hints:["describe"]},
  {inf:"disfrutar", hints:["enjoy"]},
  {inf:"empezar", hints:["begin","start"]},
  {inf:"encontrar", hints:["find","encounter"]},
  {inf:"entrar", hints:["enter","get in"]},
  {inf:"enviar", hints:["send"]},
  {inf:"escuchar", hints:["listen"]},
  {inf:"esperar", hints:["hope","wait for","wait"]},
  {inf:"estar", hints:["be (temporary)","be"]},
  {inf:"explicar", hints:["explain"]},
  {inf:"gritar", hints:["shout","yell"]},
  {inf:"haber", hints:["have (aux)"]},
  {inf:"hablar", hints:["speak","talk"]},
  {inf:"hacer", hints:["do","make"]},
  {inf:"invitar", hints:["invite"]},
  {inf:"ir", hints:["go"]},
  {inf:"jugar", hints:["play"]},
  {inf:"limpiar", hints:["clean"]},
  {inf:"llegar", hints:["arrive"]},
  {inf:"llevar", hints:["wear","bring","carry"]},
  {inf:"mirar", hints:["watch","look at"]},
  {inf:"mostrar", hints:["show"]},
  {inf:"parecer", hints:["seem","appear"]},
  {inf:"participar", hints:["participate"]},
  {inf:"pasar", hints:["pass","spend time"]},
  {inf:"perder", hints:["lose"]},
  {inf:"poder", hints:["be able","can"]},
  {inf:"poner", hints:["put","place"]},
  {inf:"preguntar", hints:["ask"]},
  {inf:"preparar", hints:["prepare"]},
  {inf:"querer", hints:["want","love"]},
  {inf:"responder", hints:["respond","answer"]},
  {inf:"romper", hints:["break"]},
  {inf:"saber", hints:["know how","know (how to)","know facts"]},
  {inf:"sacar", hints:["take out"]},
  {inf:"salir", hints:["leave","go out"]},
  {inf:"seguir", hints:["follow","continue"]},
  {inf:"ser", hints:["be (permanent)","be"]},
  {inf:"sonar", hints:["sound"]},
  {inf:"subir", hints:["go up","climb"]},
  {inf:"tener", hints:["have"]},
  {inf:"terminar", hints:["finish","end"]},
  {inf:"tomar", hints:["take","drink"]},
  {inf:"trabajar", hints:["work"]},
  {inf:"traer", hints:["bring"]},
  {inf:"venir", hints:["come"]},
  {inf:"ver", hints:["see"]},
  {inf:"vivir", hints:["live"]},
  {inf:"volver", hints:["return","come back"]},
];

const byInf = new Map(VERBS.map(v => [norm(v.inf), v]));

/* =============================
   Reflexive pronouns
============================= */
const PRON = {yo:"me", tu:"te", el:"se", nosotros:"nos", vosotros:"os", ustedes:"se"};

/* =============================
   Regular endings + spelling changes
============================= */
function verbType(inf){
  if(inf.endsWith("ar")) return "ar";
  if(inf.endsWith("er")) return "er";
  if(inf.endsWith("ir")) return "ir";
  return null;
}

const REG = {
  present:{
    ar:{yo:"o", tu:"as", el:"a", nosotros:"amos", vosotros:"áis", ustedes:"an"},
    er:{yo:"o", tu:"es", el:"e", nosotros:"emos", vosotros:"éis", ustedes:"en"},
    ir:{yo:"o", tu:"es", el:"e", nosotros:"imos", vosotros:"ís", ustedes:"en"},
  },
  imperfect:{
    ar:{yo:"aba", tu:"abas", el:"aba", nosotros:"ábamos", vosotros:"abais", ustedes:"aban"},
    er:{yo:"ía", tu:"ías", el:"ía", nosotros:"íamos", vosotros:"íais", ustedes:"ían"},
    ir:{yo:"ía", tu:"ías", el:"ía", nosotros:"íamos", vosotros:"íais", ustedes:"ían"},
  },
  preterite:{
    ar:{yo:"é", tu:"aste", el:"ó", nosotros:"amos", vosotros:"asteis", ustedes:"aron"},
    er:{yo:"í", tu:"iste", el:"ió", nosotros:"imos", vosotros:"isteis", ustedes:"ieron"},
    ir:{yo:"í", tu:"iste", el:"ió", nosotros:"imos", vosotros:"isteis", ustedes:"ieron"},
  }
};

function yoPretSpelling(inf, stem){
  if(inf.endsWith("car")) return stem.slice(0,-1) + "qu";
  if(inf.endsWith("gar")) return stem.slice(0,-1) + "gu";
  if(inf.endsWith("zar")) return stem.slice(0,-1) + "c";
  return stem;
}

/* =============================
   Hardcoded irregulars / exceptions ONLY
============================= */
const EXCEPTIONS = {
  present:{
    ser:{yo:"soy",tu:"eres",el:"es",nosotros:"somos",vosotros:"sois",ustedes:"son"},
    ir:{yo:"voy",tu:"vas",el:"va",nosotros:"vamos",vosotros:"vais",ustedes:"van"},
    estar:{yo:"estoy",tu:"estás",el:"está",nosotros:"estamos",vosotros:"estáis",ustedes:"están"},
    tener:{yo:"tengo",tu:"tienes",el:"tiene",nosotros:"tenemos",vosotros:"tenéis",ustedes:"tienen"},
    venir:{yo:"vengo",tu:"vienes",el:"viene",nosotros:"venimos",vosotros:"venís",ustedes:"vienen"},
    decir:{yo:"digo",tu:"dices",el:"dice",nosotros:"decimos",vosotros:"decís",ustedes:"dicen"},
    hacer:{yo:"hago",tu:"haces",el:"hace",nosotros:"hacemos",vosotros:"hacéis",ustedes:"hacen"},
    poner:{yo:"pongo",tu:"pones",el:"pone",nosotros:"ponemos",vosotros:"ponéis",ustedes:"ponen"},
    salir:{yo:"salgo",tu:"sales",el:"sale",nosotros:"salimos",vosotros:"salís",ustedes:"salen"},
    traer:{yo:"traigo",tu:"traes",el:"trae",nosotros:"traemos",vosotros:"traéis",ustedes:"traen"},
    saber:{yo:"sé",tu:"sabes",el:"sabe",nosotros:"sabemos",vosotros:"sabéis",ustedes:"saben"},
    ver:{yo:"veo",tu:"ves",el:"ve",nosotros:"vemos",vosotros:"veis",ustedes:"ven"},
    jugar:{yo:"juego",tu:"juegas",el:"juega",nosotros:"jugamos",vosotros:"jugáis",ustedes:"juegan"},
    poder:{yo:"puedo",tu:"puedes",el:"puede",nosotros:"podemos",vosotros:"podéis",ustedes:"pueden"},
    querer:{yo:"quiero",tu:"quieres",el:"quiere",nosotros:"queremos",vosotros:"queréis",ustedes:"quieren"},
    volver:{yo:"vuelvo",tu:"vuelves",el:"vuelve",nosotros:"volvemos",vosotros:"volvéis",ustedes:"vuelven"},
    seguir:{yo:"sigo",tu:"sigues",el:"sigue",nosotros:"seguimos",vosotros:"seguís",ustedes:"siguen"},
    empezar:{yo:"empiezo",tu:"empiezas",el:"empieza",nosotros:"empezamos",vosotros:"empezáis",ustedes:"empiezan"},
    encontrar:{yo:"encuentro",tu:"encuentras",el:"encuentra",nosotros:"encontramos",vosotros:"encontráis",ustedes:"encuentran"},
    conocer:{yo:"conozco",tu:"conoces",el:"conoce",nosotros:"conocemos",vosotros:"conocéis",ustedes:"conocen"},
    parecer:{yo:"parezco",tu:"pareces",el:"parece",nosotros:"parecemos",vosotros:"parecéis",ustedes:"parecen"},
    aparecer:{yo:"aparezco",tu:"apareces",el:"aparece",nosotros:"aparecemos",vosotros:"aparecéis",ustedes:"aparecen"},
    reir:{yo:"río",tu:"ríes",el:"ríe",nosotros:"reímos",vosotros:"reís",ustedes:"ríen"},
  },
  imperfect:{
    ser:{yo:"era",tu:"eras",el:"era",nosotros:"éramos",vosotros:"erais",ustedes:"eran"},
    ir:{yo:"iba",tu:"ibas",el:"iba",nosotros:"íbamos",vosotros:"ibais",ustedes:"iban"},
    ver:{yo:"veía",tu:"veías",el:"veía",nosotros:"veíamos",vosotros:"veíais",ustedes:"veían"},
  },
  preterite:{
    ser:{yo:"fui",tu:"fuiste",el:"fue",nosotros:"fuimos",vosotros:"fuisteis",ustedes:"fueron"},
    ir:{yo:"fui",tu:"fuiste",el:"fue",nosotros:"fuimos",vosotros:"fuisteis",ustedes:"fueron"},
    ver:{yo:"vi",tu:"viste",el:"vio",nosotros:"vimos",vosotros:"visteis",ustedes:"vieron"},
    dar:{yo:"di",tu:"diste",el:"dio",nosotros:"dimos",vosotros:"disteis",ustedes:"dieron"},
    haber:{yo:"hube",tu:"hubiste",el:"hubo",nosotros:"hubimos",vosotros:"hubisteis",ustedes:"hubieron"},
    estar:{yo:"estuve",tu:"estuviste",el:"estuvo",nosotros:"estuvimos",vosotros:"estuvisteis",ustedes:"estuvieron"},
    tener:{yo:"tuve",tu:"tuviste",el:"tuvo",nosotros:"tuvimos",vosotros:"tuvisteis",ustedes:"tuvieron"},
    poder:{yo:"pude",tu:"pudiste",el:"pudo",nosotros:"pudimos",vosotros:"pudisteis",ustedes:"pudieron"},
    poner:{yo:"puse",tu:"pusiste",el:"puso",nosotros:"pusimos",vosotros:"pusisteis",ustedes:"pusieron"},
    saber:{yo:"supe",tu:"supiste",el:"supo",nosotros:"supimos",vosotros:"supisteis",ustedes:"supieron"},
    querer:{yo:"quise",tu:"quisiste",el:"quiso",nosotros:"quisimos",vosotros:"quisisteis",ustedes:"quisieron"},
    decir:{yo:"dije",tu:"dijiste",el:"dijo",nosotros:"dijimos",vosotros:"dijisteis",ustedes:"dijeron"},
    hacer:{yo:"hice",tu:"hiciste",el:"hizo",nosotros:"hicimos",vosotros:"hicisteis",ustedes:"hicieron"},
    venir:{yo:"vine",tu:"viniste",el:"vino",nosotros:"vinimos",vosotros:"vinisteis",ustedes:"vinieron"},
    traer:{yo:"traje",tu:"trajiste",el:"trajo",nosotros:"trajimos",vosotros:"trajisteis",ustedes:"trajeron"},
    andar:{yo:"anduve",tu:"anduviste",el:"anduvo",nosotros:"anduvimos",vosotros:"anduvisteis",ustedes:"anduvieron"},
    reir:{yo:"reí",tu:"reíste",el:"rió",nosotros:"reímos",vosotros:"reísteis",ustedes:"rieron"},
  }
};

function normalizeInfKey(infN){
  if(infN === "reirse") return "reir";
  if(infN === "reir") return "reir";
  return infN;
}

function conjugate(infRaw, tense, person, isRef){
  const infN = norm(infRaw);
  const key = normalizeInfKey(infN);

  const ex = EXCEPTIONS[tense] && EXCEPTIONS[tense][key];
  if(ex){
    const base = ex[person];
    return isRef ? `${PRON[person]} ${base}` : base;
  }

  const type = verbType(infN);
  if(!type) return null;

  let stem = infN.slice(0,-2);
  if(tense === "preterite" && person === "yo") stem = yoPretSpelling(infN, stem);

  const end = REG[tense][type][person];
  if(!end) return null;

  const form = stem + end;
  return isRef ? `${PRON[person]} ${form}` : form;
}

/* =============================
   "AI" Guessing: synonyms + scoring + top suggestions
============================= */
const SYN_REPLACERS = [
  // strong disambiguations
  {re:/\bknow\s*\(someone\)\b|\bknow someone\b|\bmeet\b|\bencounter\b/g, inf:"conocer"},
  {re:/\bknow\s*\(how to\)\b|\bknow how\b|\bknow\s*\(facts\)\b/g, inf:"saber"},
  // common prompt combos
  {re:/\ballow\b|\blet\b|\bleave behind\b/g, inf:"dejar"},
  {re:/\btake out\b/g, inf:"sacar"},
  {re:/\blaugh\b/g, inf:"reirse"},
  {re:/\bshout\b|\byell\b/g, inf:"gritar"},
  {re:/\barrive\b/g, inf:"llegar"},
  {re:/\bdecorate\b/g, inf:"decorar"},
  {re:/\bshare\b/g, inf:"compartir"},
];

function extractVerbSpan(textN){
  // everything after subject is often the meaning; try that first
  // but keep it robust: just use the whole string
  return textN;
}

function scoreVerb(queryN, v){
  // Score uses:
  // 1) direct inclusion of infinitive
  // 2) synonym replacement hits
  // 3) overlap with hint words
  // 4) fuzzy similarity between query and hints/infinitive
  let score = 0;
  const infN = norm(v.inf);

  if(queryN.includes(infN)) score += 10;

  // hint overlap
  const qWords = new Set(words(queryN));
  for(const h of (v.hints||[])){
    const hw = words(h);
    let hits = 0;
    for(const w of hw) if(qWords.has(w)) hits++;
    score += hits * 2;
    score += Math.round(similarity(queryN, h) * 4);
  }

  // fuzzy to infinitive (small)
  score += Math.round(similarity(queryN, infN) * 2);

  return score;
}

function guessVerbCandidates(textN){
  // 1) If any infinitive is explicitly present, return it as top
  const infKeys = Array.from(byInf.keys()).sort((a,b)=>b.length-a.length);
  for(const inf of infKeys){
    if(textN.includes(inf)) return [{inf, score: 999}];
  }

  // 2) If synonym replacers match, return their target at top (but still compute others)
  let forced = [];
  for(const r of SYN_REPLACERS){
    if(r.re.test(textN)) forced.push(norm(r.inf));
  }
  forced = uniq(forced);

  const q = extractVerbSpan(textN);
  const scored = VERBS.map(v => ({inf: norm(v.inf), score: scoreVerb(q, v)}))
    .sort((a,b)=>b.score-a.score);

  // boost forced hits
  if(forced.length){
    for(const f of forced){
      const idx = scored.findIndex(x => x.inf === f);
      if(idx >= 0) scored[idx].score += 50;
    }
    scored.sort((a,b)=>b.score-a.score);
  }

  // keep top 6 with positive-ish score
  return scored.filter(x => x.score > 0).slice(0,6);
}

/* =============================
   UI
============================= */
function renderExceptions(){
  const lines = [];
  lines.push("Only these are hardcoded. Everything else is regular rules + spelling-change yo preterite.");
  lines.push("");
  lines.push("Present irregulars:");
  lines.push("ser, ir, estar, tener, venir, decir, hacer, poner, salir, traer, saber, ver, jugar, poder, querer, volver, seguir, empezar, encontrar, conocer, parecer, aparecer, reír");
  lines.push("");
  lines.push("Imperfect irregulars:");
  lines.push("ser, ir, ver");
  lines.push("");
  lines.push("Preterite irregulars:");
  lines.push("ser/ir, ver, dar, haber, estar, tener, poder, poner, saber, querer, decir, hacer, venir, traer, andar, reír");
  lines.push("");
  lines.push("Spelling-change yo preterite:");
  lines.push("-car → qu (busqué), -gar → gu (llegué), -zar → c (empecé), plus sacar → saqué");
  document.getElementById("exceptions").textContent = lines.join("\n");
}
renderExceptions();

function clearChoices(){
  document.getElementById("choices").innerHTML = "";
}

function showChoices(cands, onPick){
  const box = document.getElementById("choices");
  box.innerHTML = "";
  for(const c of cands){
    const chip = document.createElement("div");
    chip.className = "chip";
    chip.textContent = c.inf;
    chip.addEventListener("click", () => onPick(c.inf));
    box.appendChild(chip);
  }
}

function runWithChosenVerb(infChosen){
  const raw = document.getElementById("input").value;
  const t = norm(raw);

  const tense = parseTense(t);
  const person = parseSubject(t);

  const out = document.getElementById("output");
  const dbg = document.getElementById("debug");

  if(!tense || !person){
    out.innerHTML = `<span class="error">Could not parse tense/subject.</span>`;
    dbg.textContent = `Detected: tense=${tense||"?"}, subject=${person||"?"}`;
    return;
  }

  const v = byInf.get(norm(infChosen));
  const isRef = !!(v && v.ref);

  const result = conjugate(infChosen, tense, person, isRef);
  if(!result){
    out.innerHTML = `<span class="error">No form available.</span>`;
    dbg.textContent = `Detected: tense=${tense}, subject=${person}, verb=${infChosen} (reflexive=${isRef})`;
    return;
  }

  clearChoices();
  out.textContent = result;
  dbg.textContent =
    `Detected: tense=${tense}, subject=${person}, verb=${infChosen}${isRef ? " (reflexive)" : ""}\n` +
    `If the verb guess was wrong, re-run and click a different suggestion.`;
}

function run(){
  const raw = document.getElementById("input").value;
  const t = norm(raw);

  const tense = parseTense(t);
  const person = parseSubject(t);

  const out = document.getElementById("output");
  const dbg = document.getElementById("debug");

  if(!tense || !person){
    out.innerHTML = `<span class="error">Could not parse input.</span>`;
    dbg.textContent = `Detected: tense=${tense||"?"}, subject=${person||"?"}\nMake sure your line includes tense + subject.`;
    clearChoices();
    return;
  }

  const cands = guessVerbCandidates(t);
  if(!cands.length){
    out.innerHTML = `<span class="error">Could not guess the verb.</span>`;
    dbg.textContent = `Detected: tense=${tense}, subject=${person}\nTry adding a clearer English meaning or paste the Spanish infinitive.`;
    clearChoices();
    return;
  }

  // if top candidate is confident enough, auto-use it, but still show options
  const top = cands[0];
  const confident = top.score >= 10 || top.score === 999;

  if(confident){
    runWithChosenVerb(top.inf);
  }else{
    out.innerHTML = `<span class="error">Ambiguous verb. Pick one:</span>`;
    dbg.textContent = `Detected: tense=${tense}, subject=${person}\nTop guesses shown below.`;
  }

  showChoices(cands, (inf) => runWithChosenVerb(inf));
}

document.getElementById("go").addEventListener("click", run);
document.getElementById("clear").addEventListener("click", ()=>{
  document.getElementById("input").value="";
  document.getElementById("output").textContent="";
  document.getElementById("debug").textContent="";
  clearChoices();
  document.getElementById("input").focus();
});
document.getElementById("input").addEventListener("keydown",(e)=>{
  if(e.key === "Enter" && (e.ctrlKey || e.metaKey)){
    e.preventDefault();
    run();
  }
});
</script>
</body>
</html>
